= MEGA-Infrastructure

The MEGA infrastructure project.

== Infrastructure

The MEGA Project is hosted in Openshift and split to the following 3 stages (Openshift Projects):

. ``mega-dev`` +
 The development stage, where usually the current ``develop`` state is deployed on.
. ``mega-test`` +
 The test environment where the acceptance tests are performed
. ``mega-prod`` +
 The production system of the MEGA Project

The cited image illustrates the system of the MEGA Project, its involved services, interactions and zones. Each zone is protected by OAuth whereby each zone uses its own ``clientId``.

.Mega System
image::/doc/images/mega-system.png[]

== Prerequisites


=== Google OAuth2 client setup

See link:https://developers.google.com/identity/protocols/OAuth2UserAgent[here] for a description how to setup a google oauth client.

== Project Resources

=== Dockerfiles

The cited Dockerfiles are used to build the jenkins build agents for the MEGA Project. 

* ``link:/docker/agent-nodejs/Dockerfile[agent-nodejs/Dockerfile]`` +
 The Dockerfile for building the nodejs build agent
* ``link:/docker/agent-jdk/Dockerfile[agent-jdk/Dockerfile]`` +
 The Dockerfile for building the OpenJDK build agent

=== S2I 

We use a custom Jenkins which is based on the official Openshift-Jenkins-Image and 
which is build via the S2I mechanism.

* ``link:/s2i/jenkins[s2i/jenkins]`` +
  The directory holding the s2i sources
* ``link:/s2i/jenkins/plugins.txt[s2i/jenkins/plugins.txt]`` +
  The plugins.txt which defines the plugins and plugins version the Mega Jenkins uses

=== Configuration files

==== Jenkins

Jenkins is configured via the link:https://jenkins.io/projects/jcasc/[configureation-as-code] plugin which allows to configure Jenkins via YAML config files.

* ``link:/config/jenkins/jenkins-config.yaml[/config/jenkins/jenkins-config.yaml]`` +
  The YAML configuration file which configures the Jenkins instance and the MEGA Job Definitions

TIP: The YAML configuration file references secrets via environment variables, which are injected into the container by Openshift. Because there are no secrets, this configuration file is part of the repository

==== MEGA

Configurations for MEGA are provided via properties files, which contain secrets and therefore need to be provided manually. Each used stage needs its own configuration file to separate the configurations per stage. 

* ``mega-secrets.<STAGE>.properties``

TIP: See link:https://github.com/Gepardec/mega[MEGA Repository] for possible configuration values.


// --------------------------------------------------------------------------------

== Openshift Dev Project

.Secrets
[source,bash]
----
# Create secrets
STAGE=[dev|prod|test] oc apps/ocp.sh createMegaSecrets
STAGE=[dev|prod|test] oc apps/ocp.sh createJenkinsSecrets

# Delete secrets
oc apps/ocp.sh deleteMegaSecrets
oc apps/ocp.sh deleteJenkinsSecrets

# Delete/Create secrets
STAGE=[dev|prod|test] oc apps/ocp.sh recreateMegaSecrets
STAGE=[dev|prod|test] oc apps/ocp.sh recreateJenkinsSecrets
----

.Build Configurations
[source,bash]
----
# Create all build configs
oc apps/ocp.sh createBuildConfigs

# Delete all build configs
oc apps/ocp.sh deleteBuildConfigs

# Delete/Create all build configs
oc apps/ocp.sh recreateBuildConfigs
----

.Jenkins
[source,bash]
----
# Create jenkins
oc apps/ocp.sh createJenkins

# Delete jenkins
oc apps/ocp.sh deleteJenkins

# Delete/Create jenkins
oc apps/ocp.sh recreateJenkins
----

IMPORTANT: Ensure that the properties in ``ocp/jenkins.properties`` and env vars in ``apps/ocp.sh`` are properly setup for your needs.

== Openshift Test/Prod Project

.Secrets
[source,bash]
----
oc create secret generic mega-secrets --from-file=filename=mega-secrets.properties
----

IMPORTANT: Ensure that the configuration is properly setup for your environment
